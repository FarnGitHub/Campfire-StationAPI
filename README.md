Mostly based on https://github.com/connor135246/Campfire-Backport/